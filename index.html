<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLINK Random Player</title>
    <style>
        :root { --pink: #ff007f; --black: #000; --card: #121212; }
        body { font-family: -apple-system, sans-serif; background: var(--black); color: white; margin: 0; padding: 0; }
        header { padding: 15px; text-align: center; border-bottom: 2px solid var(--pink); }
        #logo { width: 60px; cursor: pointer; }
        .player-box { width: 100%; aspect-ratio: 16/9; background: #000; border-bottom: 1px solid #333; }
        iframe { width: 100%; height: 100%; border: none; }
        .main-btn { background: var(--pink); color: white; border: none; padding: 15px; width: 90%; margin: 20px 5%; border-radius: 30px; font-weight: bold; font-size: 1rem; }
        .list-container { padding: 15px; }
        .item { background: var(--card); padding: 12px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--pink); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: #222; width: 85%; padding: 20px; border-radius: 15px; border: 1px solid var(--pink); }
        input { width: 100%; padding: 12px; margin: 10px 0; background: #000; color: white; border: 1px solid #444; box-sizing: border-box; border-radius: 8px; }
        .fab { position: fixed; bottom: 25px; right: 25px; background: var(--pink); width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 30px; }
    </style>
</head>
<body>

<header>
    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Blackpink_Logo.png" id="logo" onclick="logoTrigger()">
</header>

<div class="player-box">
    <iframe id="main-frame" src="about:blank" allow="autoplay; encrypted-media; playsinline" allowfullscreen></iframe>
</div>

<button class="main-btn" onclick="playRandom()">ðŸ”€ RANDOM PLAY ALL</button>

<div class="list-container" id="display-list"></div>

<button class="fab" onclick="document.getElementById('userModal').style.display='flex'">+</button>

<div id="userModal" class="modal">
    <div class="modal-content">
        <h3>Add to My List</h3>
        <input type="text" id="uName" placeholder="Song Name">
        <input type="text" id="uUrl" placeholder="Paste YouTube Link">
        <button class="main-btn" onclick="saveLocal()">SAVE LOCALLY</button>
        <button onclick="closeModals()" style="background:none; color:gray; border:none; width:100%;">Cancel</button>
    </div>
</div>

<div id="adminModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--pink)">Admin Access</h3>
        <input type="password" id="adminPass" placeholder="Password">
        <input type="text" id="aUrl" placeholder="Link for Global Sheet">
        <button class="main-btn" onclick="sendToCloud()">UPDATE GLOBAL SHEET</button>
        <button onclick="closeModals()" style="background:none; color:gray; border:none; width:100%;">Close</button>
    </div>
</div>

<script>
    // 1. CONFIGURATION
    const SHEET_CSV = "YOUR_GOOGLE_SHEET_CSV_URL"; // Publish Sheet to web as CSV
    const APPS_SCRIPT_URL = "YOUR_SCRIPT_URL"; 
    let cloudItems = [];
    let clickCount = 0;

    // 2. STEALTH TRIGGER
    function logoTrigger() {
        clickCount++;
        if (clickCount >= 10) {
            document.getElementById('adminModal').style.display = 'flex';
            clickCount = 0;
        }
    }

    // 3. UNIVERSAL LINK PARSER
    function getID(url) {
        const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|shorts\/|embed\/|v\/))([\w-]{11})/);
        return match ? match[1] : null;
    }

    // 4. PLAYER ENGINE BRIDGE
    function runVideo(url) {
        const id = getID(url);
        if (id) {
            document.getElementById('main-frame').src = `./player.html?v=${id}&autoplay=1`;
        }
    }

    // 5. LOCAL STORAGE
    function saveLocal() {
        const name = document.getElementById('uName').value;
        const url = document.getElementById('uUrl').value;
        if (getID(url) && name) {
            let list = JSON.parse(localStorage.getItem('bp_local')) || [];
            list.push({ name, url });
            localStorage.setItem('bp_local', JSON.stringify(list));
            closeModals();
            renderList();
        }
    }

    async function syncCloud() {
        try {
            const res = await fetch(SHEET_CSV);
            const text = await res.text();
            const rows = text.split('\n').slice(1);
            cloudItems = rows.map(r => {
                const parts = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                return { name: parts[0].replace(/"/g, ''), url: parts[1].replace(/"/g, '') };
            }).filter(i => i.url);
            renderList();
        } catch(e) { renderList(); }
    }

    function renderList() {
        const local = JSON.parse(localStorage.getItem('bp_local')) || [];
        const container = document.getElementById('display-list');
        container.innerHTML = local.map(item => `
            <div class="item">
                <span>${item.name}</span>
                <button onclick="runVideo('${item.url}')" style="background:#333; color:var(--pink); border:none; border-radius:50%; width:30px; height:30px;">â–¶</button>
            </div>
        `).join('');
    }

    function playRandom() {
        const local = JSON.parse(localStorage.getItem('bp_local')) || [];
        const total = [...cloudItems, ...local];
        if (total.length > 0) {
            const r = total[Math.floor(Math.random() * total.length)];
            runVideo(r.url);
        }
    }

    function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    window.onload = syncCloud;
</script>
</body>
</html>
